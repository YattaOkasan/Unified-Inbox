<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Inbox & Tasks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filter-tabs::-webkit-scrollbar {
            display: none;
        }

        .filter-tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .tag-filters {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px;
        }

        .tag-filters::-webkit-scrollbar {
            display: none;
        }

        .tag-filter-button {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 16px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tag-filter-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .tag-filter-button.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .item-tags {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .item-tag {
            display: inline-block;
            padding: 3px 8px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .item-tag.work {
            background: #e3f2fd;
            color: #1976d2;
        }

        .item-tag.urgent {
            background: #ffebee;
            color: #c62828;
        }

        .item-tag.personal {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .item-tag.meeting {
            background: #fff3e0;
            color: #e65100;
        }

        .item-tag.finance {
            background: #e0f2f1;
            color: #00695c;
        }

        .tag-input-container {
            margin-top: 8px;
        }

        .tag-pill {
            display: inline-block;
            padding: 4px 10px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 16px;
            font-size: 13px;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .tag-pill .remove-tag {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .search-bar {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            background: #f9f9f9;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        .message-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message-item:active {
            background: #f5f5f5;
        }

        .message-item.unread {
            background: #f8f9ff;
        }

        .message-item.task {
            border-left: 4px solid #667eea;
        }

        .message-item.completed {
            opacity: 0.6;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            transition: all 0.2s;
            margin-top: 2px;
        }

        .task-checkbox:hover {
            background: #f8f9ff;
        }

        .task-checkbox.checked {
            background: #667eea;
            border-color: #667eea;
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-item.completed .message-subject {
            text-decoration: line-through;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .platform-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .platform-badge.email {
            background: #e3f2fd;
            color: #1976d2;
        }

        .platform-badge.teams {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .platform-badge.task {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .platform-badge.typed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .platform-badge.handwritten {
            background: #fff3e0;
            color: #e65100;
        }

        .platform-badge.voice {
            background: #fce4ec;
            color: #c2185b;
        }

        .platform-badge.calendar {
            background: #fff9c4;
            color: #f57f17;
        }

        .message-item.calendar {
            border-left: 4px solid #f57f17;
        }

        .event-time {
            display: inline-block;
            padding: 3px 8px;
            background: #fff9c4;
            color: #f57f17;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .sender-name {
            font-weight: 600;
            font-size: 15px;
            flex: 1;
        }

        .timestamp {
            font-size: 13px;
            color: #888;
        }

        .message-subject {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
        }

        .message-preview {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .stats-bar {
            padding: 12px 20px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #666;
        }

        .sort-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            color: #666;
        }

        .sort-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .due-date-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .due-date-badge.overdue {
            background: #fee;
            color: #c00;
        }

        .due-date-badge.today {
            background: #fff3e0;
            color: #e65100;
        }

        .due-date-badge.upcoming {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .due-date-badge.future {
            background: #f5f5f5;
            color: #666;
        }

        .message-detail {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            display: none;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
        }

        .message-detail.active {
            display: flex;
        }

        .detail-header {
            padding: 16px 20px;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .detail-meta {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .detail-meta-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-meta-label {
            font-weight: 600;
            width: 80px;
            color: #666;
        }

        .detail-meta-value {
            flex: 1;
        }

        .detail-body {
            line-height: 1.6;
            font-size: 15px;
        }

        .detail-actions {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }

        .detail-action-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .detail-action-button.primary {
            background: #667eea;
            color: white;
        }

        .detail-action-button.primary:active {
            background: #5568d3;
        }

        .detail-action-button.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .detail-action-button.secondary:active {
            background: #e5e5e5;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .compose-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            max-width: 600px;
            margin: 0 auto;
        }

        .compose-modal.active {
            display: flex;
        }

        .compose-content {
            background: white;
            width: 100%;
            border-radius: 16px 16px 0 0;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .compose-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compose-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }

        .compose-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .message-input-wrapper {
            position: relative;
        }

        .message-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            padding-bottom: 50px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
        }

        .message-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-tools {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .tool-button {
            padding: 8px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .tool-button:hover {
            background: #ebebeb;
        }

        .tool-button:active {
            transform: scale(0.95);
        }

        .tool-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tool-button.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .ai-suggestions {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9ff;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            display: none;
        }

        .ai-suggestions.active {
            display: block;
        }

        .ai-suggestions-header {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .suggestion-option {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .suggestion-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .suggestion-option:last-child {
            margin-bottom: 0;
        }

        .compose-actions {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }

        .action-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-button.primary {
            background: #667eea;
            color: white;
        }

        .action-button.primary:active {
            background: #5568d3;
        }

        .action-button.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .action-button.secondary:active {
            background: #e5e5e5;
        }

        .voice-status {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .handwriting-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .handwriting-modal.active {
            display: flex;
        }

        .handwriting-container {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .handwriting-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .handwriting-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .handwriting-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .canvas-container {
            position: relative;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            touch-action: none;
            margin-bottom: 16px;
        }

        #handwriting-canvas {
            display: block;
            width: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .canvas-tool-button {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .canvas-tool-button:hover {
            background: #ebebeb;
        }

        .canvas-tool-button:active {
            transform: scale(0.95);
        }

        .recognized-text {
            padding: 12px;
            background: #f8f9ff;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            min-height: 60px;
            font-size: 15px;
            line-height: 1.5;
            color: #333;
        }

        .recognized-text.empty {
            color: #999;
            font-style: italic;
        }

        .handwriting-actions {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }

        .handwriting-hint {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 8px;
        }

        @media (max-width: 600px) {
            body {
                max-width: 100%;
            }
            
            .handwriting-container {
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¨ Unified Inbox</h1>
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="email">Email</button>
            <button class="filter-tab" data-filter="teams">Teams</button>
            <button class="filter-tab" data-filter="tasks">Tasks</button>
            <button class="filter-tab" data-filter="calendar">Calendar</button>
            <button class="filter-tab" data-filter="active-tasks">Active Tasks</button>
            <button class="filter-tab" data-filter="handwritten">Handwritten</button>
        </div>
        <div class="tag-filters" id="tag-filters">
            <!-- Tag filter buttons will appear here -->
        </div>
    </div>

    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search messages and tasks...">
    </div>

    <div class="stats-bar">
        <span id="message-count">Loading...</span>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span id="unread-count"></span>
            <select id="sort-select" class="sort-select">
                <option value="recent">Sort: Recent</option>
                <option value="due-date">Sort: Due Date</option>
            </select>
        </div>
    </div>

    <div class="messages-container" id="messages-container">
        <!-- Items will be inserted here -->
    </div>

    <button class="fab" title="Add new task">‚ûï</button>

    <div class="compose-modal" id="compose-modal">
        <div class="compose-content">
            <div class="compose-header">
                <h2>New Task</h2>
                <button class="close-button" id="close-compose">√ó</button>
            </div>
            <div class="compose-body">
                <div class="form-group">
                    <label class="form-label">Input Method</label>
                    <select class="form-select" id="platform-select">
                        <option value="typed">‚úçÔ∏è Typed</option>
                        <option value="handwritten">üñäÔ∏è Handwritten</option>
                        <option value="voice">üé§ Voice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="subject-input" placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date (Optional)</label>
                    <input type="date" class="form-input" id="due-date-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (Optional)</label>
                    <input type="text" class="form-input" id="tags-input" placeholder="e.g., work, urgent, personal">
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">Separate tags with commas</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <div class="message-input-wrapper">
                        <textarea class="message-textarea" id="message-textarea" placeholder="Add any additional details..."></textarea>
                        <div class="input-tools">
                            <button class="tool-button" id="voice-button" title="Voice to text">
                                üé§ Voice
                            </button>
                            <button class="tool-button" id="handwriting-button" title="Handwriting to text">
                                ‚úçÔ∏è Write
                            </button>
                            <button class="tool-button" id="ai-button" title="AI writing assistant">
                                ‚ú® AI Assist
                            </button>
                        </div>
                    </div>
                    <div class="voice-status" id="voice-status"></div>
                </div>
                <div class="ai-suggestions" id="ai-suggestions">
                    <div class="ai-suggestions-header">
                        <span>‚ú®</span>
                        <span>AI Suggestions</span>
                    </div>
                    <div id="suggestions-container">
                        <!-- Suggestions will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="compose-actions">
                <button class="action-button secondary" id="cancel-compose">Cancel</button>
                <button class="action-button primary" id="send-message">Add Task</button>
            </div>
        </div>
    </div>

    <div class="handwriting-modal" id="handwriting-modal">
        <div class="handwriting-container">
            <div class="handwriting-header">
                <h3>‚úçÔ∏è Write with Stylus</h3>
                <button class="close-button" id="close-handwriting">√ó</button>
            </div>
            <div class="handwriting-body">
                <div class="canvas-tools">
                    <button class="canvas-tool-button" id="clear-canvas">üóëÔ∏è Clear</button>
                    <button class="canvas-tool-button" id="recognize-text">‚ú® Convert to Text</button>
                    <button class="canvas-tool-button" id="undo-stroke">‚Ü∂ Undo</button>
                </div>
                <div class="canvas-container">
                    <canvas id="handwriting-canvas" width="460" height="300"></canvas>
                </div>
                <div class="handwriting-hint">
                    Write naturally with your stylus or finger
                </div>
                <div class="recognized-text empty" id="recognized-text">
                    Recognized text will appear here...
                </div>
            </div>
            <div class="handwriting-actions">
                <button class="action-button secondary" id="cancel-handwriting">Cancel</button>
                <button class="action-button primary" id="insert-handwriting">Insert Text</button>
            </div>
        </div>
    </div>

    <div class="message-detail" id="message-detail">
        <div class="detail-header">
            <button class="back-button" id="back-button">‚Üê</button>
            <span>Details</span>
        </div>
        <div class="detail-content" id="detail-content">
            <!-- Detail will be inserted here -->
        </div>
        <div class="detail-actions" id="detail-actions">
            <!-- Action buttons will be inserted here -->
        </div>
    </div>

    <script>
        // Sample data - mix of emails, Teams messages, and tasks
        const sampleMessages = [
            {
                id: 1,
                type: 'email',
                platform: 'email',
                sender: 'Sarah Chen',
                subject: 'Q1 Marketing Review',
                preview: 'Hey team, I\'ve uploaded the Q1 marketing metrics to the shared folder. Can everyone review before our meeting tomorrow?',
                body: 'Hey team,\n\nI\'ve uploaded the Q1 marketing metrics to the shared folder. Can everyone review before our meeting tomorrow at 2pm?\n\nKey highlights:\n- 23% increase in engagement\n- New campaign performing above expectations\n- Budget optimization recommendations included\n\nLet me know if you have any questions!\n\nBest,\nSarah',
                timestamp: '10m ago',
                unread: true,
                completed: false,
                from: 'sarah.chen@company.com',
                tags: ['work', 'meeting']
            },
            {
                id: 2,
                type: 'task',
                platform: 'handwritten',
                sender: '',
                subject: 'Buy groceries for dinner',
                preview: 'Milk, eggs, bread, chicken, vegetables',
                body: 'Milk, eggs, bread, chicken, vegetables',
                timestamp: 'Today',
                unread: false,
                completed: false,
                dueDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], // Tomorrow
                tags: ['personal']
            },
            {
                id: 3,
                type: 'teams',
                platform: 'teams',
                sender: 'Alex Thompson',
                subject: 'Quick question about deployment',
                preview: '@everyone - Has anyone deployed to production today? I\'m seeing some unusual activity in the logs.',
                body: '@everyone - Has anyone deployed to production today? I\'m seeing some unusual activity in the logs.\n\nSpecifically:\n- Increased error rates around 9:15am\n- Database connection spikes\n- Cache invalidation issues\n\nNeed to know if this is related to a deployment or if we should investigate further.\n\nThanks!',
                timestamp: '2h ago',
                unread: true,
                completed: false,
                channel: 'DevOps',
                tags: ['work', 'urgent']
            },
            {
                id: 4,
                type: 'task',
                platform: 'typed',
                sender: '',
                subject: 'Finish project proposal',
                preview: 'Complete the budget section and timeline',
                body: 'Complete the budget section and timeline',
                timestamp: 'Today',
                unread: false,
                completed: false,
                dueDate: new Date(Date.now() - 86400000).toISOString().split('T')[0], // Yesterday (overdue)
                tags: ['work', 'urgent']
            },
            {
                id: 5,
                type: 'email',
                platform: 'email',
                sender: 'HR Department',
                subject: 'Reminder: Performance Review Due Friday',
                preview: 'This is a friendly reminder that your self-assessment for the annual performance review is due this Friday, February 21st.',
                body: 'Hi Team,\n\nThis is a friendly reminder that your self-assessment for the annual performance review is due this Friday, February 21st at 5pm.\n\nPlease ensure you:\n1. Complete all sections of the form\n2. Provide specific examples of achievements\n3. Set goals for the upcoming quarter\n\nThe form can be accessed through the HR portal.\n\nIf you have any questions, please reach out to hr@company.com\n\nBest regards,\nHR Team',
                timestamp: '3h ago',
                unread: false,
                completed: false,
                from: 'hr@company.com',
                tags: ['work']
            },
            {
                id: 6,
                type: 'task',
                platform: 'voice',
                sender: '',
                subject: 'Call dentist for appointment',
                preview: 'Schedule cleaning appointment for next month',
                body: 'Schedule cleaning appointment for next month',
                timestamp: 'Yesterday',
                unread: false,
                completed: true,
                dueDate: null,
                tags: ['personal']
            },
            {
                id: 7,
                type: 'teams',
                platform: 'teams',
                sender: 'Lisa Park',
                subject: 'Coffee chat?',
                preview: 'Hey! Are you free for a quick coffee chat this week? Would love to catch up and discuss the new initiative.',
                body: 'Hey! üëã\n\nAre you free for a quick coffee chat this week? Would love to catch up and discuss the new initiative.\n\nI\'m available:\n- Wednesday 3-4pm\n- Thursday 10-11am\n- Friday afternoon\n\nLet me know what works for you!\n\nCheers,\nLisa',
                timestamp: 'Yesterday',
                unread: false,
                completed: false,
                channel: 'Direct Message',
                tags: ['work', 'meeting']
            },
            {
                id: 8,
                type: 'task',
                platform: 'handwritten',
                sender: '',
                subject: 'Update LinkedIn profile',
                preview: 'Add recent project experience and new skills',
                body: 'Add recent project experience and new skills',
                timestamp: '2 days ago',
                unread: false,
                completed: true,
                dueDate: new Date(Date.now() + 604800000).toISOString().split('T')[0], // Next week
                tags: ['personal']
            },
            {
                id: 9,
                type: 'task',
                platform: 'typed',
                sender: '',
                subject: 'Submit expense report',
                preview: 'Compile receipts and submit monthly expenses',
                body: 'Compile receipts and submit monthly expenses',
                timestamp: '3 days ago',
                unread: false,
                completed: false,
                dueDate: new Date().toISOString().split('T')[0], // Today
                tags: ['work', 'finance']
            },
            {
                id: 10,
                type: 'calendar',
                platform: 'calendar',
                sender: '',
                subject: 'Team Standup',
                preview: 'Daily sync with engineering team',
                body: 'Daily standup meeting\n\nLocation: Conference Room A / Zoom\n\nAgenda:\n- Yesterday\'s progress\n- Today\'s plans\n- Blockers',
                timestamp: 'Today',
                unread: false,
                completed: false,
                eventDate: new Date().toISOString().split('T')[0],
                eventTime: '09:00 AM',
                eventEndTime: '09:30 AM',
                location: 'Conference Room A',
                tags: ['work', 'meeting']
            },
            {
                id: 11,
                type: 'calendar',
                platform: 'calendar',
                sender: '',
                subject: 'Client Presentation',
                preview: 'Q1 results presentation for Acme Corp',
                body: 'Quarterly business review with Acme Corp\n\nAttendees:\n- Sarah Chen\n- Client stakeholders\n- Product team\n\nPreparation needed:\n- Finalize slides\n- Review metrics',
                timestamp: 'Tomorrow',
                unread: false,
                completed: false,
                eventDate: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                eventTime: '02:00 PM',
                eventEndTime: '03:00 PM',
                location: 'Zoom',
                tags: ['work', 'meeting', 'urgent']
            },
            {
                id: 12,
                type: 'calendar',
                platform: 'calendar',
                sender: '',
                subject: 'Dentist Appointment',
                preview: 'Regular cleaning and checkup',
                body: 'Dental cleaning appointment\n\nDr. Smith\nLocation: Downtown Dental\n123 Main St\n\nReminder: Bring insurance card',
                timestamp: 'Next week',
                unread: false,
                completed: false,
                eventDate: new Date(Date.now() + 604800000).toISOString().split('T')[0],
                eventTime: '10:30 AM',
                eventEndTime: '11:30 AM',
                location: 'Downtown Dental',
                tags: ['personal']
            },
            {
                id: 13,
                type: 'calendar',
                platform: 'calendar',
                sender: '',
                subject: 'Lunch with Lisa',
                preview: 'Catch up over lunch',
                body: 'Lunch meeting with Lisa Park\n\nLocation: The Garden Caf√©\n\nTopics:\n- New project ideas\n- Team dynamics\n- Career development',
                timestamp: 'Tomorrow',
                unread: false,
                completed: false,
                eventDate: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                eventTime: '12:00 PM',
                eventEndTime: '01:00 PM',
                location: 'The Garden Caf√©',
                tags: ['work', 'personal']
            }
        ];

        let currentFilter = 'all';
        let currentSearch = '';
        let currentSort = 'recent';
        let currentTagFilter = null;
        let allMessages = [...sampleMessages];
        let nextId = 10;

        function getAllTags() {
            const tagSet = new Set();
            allMessages.forEach(msg => {
                if (msg.tags) {
                    msg.tags.forEach(tag => tagSet.add(tag));
                }
            });
            return Array.from(tagSet).sort();
        }

        function renderTagFilters() {
            const container = document.getElementById('tag-filters');
            const tags = getAllTags();
            
            if (tags.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = tags.map(tag => `
                <button class="tag-filter-button ${currentTagFilter === tag ? 'active' : ''}" data-tag="${tag}">
                    #${tag}
                </button>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.tag-filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tag = button.dataset.tag;
                    if (currentTagFilter === tag) {
                        currentTagFilter = null;
                    } else {
                        currentTagFilter = tag;
                    }
                    renderTagFilters();
                    renderMessages();
                });
            });
        }

        function getDueDateBadge(dueDate) {
            if (!dueDate) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let badgeClass = 'future';
            let badgeText = '';
            
            if (diffDays < 0) {
                badgeClass = 'overdue';
                badgeText = `Overdue ${Math.abs(diffDays)}d`;
            } else if (diffDays === 0) {
                badgeClass = 'today';
                badgeText = 'Due Today';
            } else if (diffDays === 1) {
                badgeClass = 'upcoming';
                badgeText = 'Due Tomorrow';
            } else if (diffDays <= 7) {
                badgeClass = 'upcoming';
                badgeText = `Due in ${diffDays}d`;
            } else {
                badgeClass = 'future';
                badgeText = `Due ${due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
            
            return `<span class="due-date-badge ${badgeClass}">${badgeText}</span>`;
        }

        function formatDueDate(dueDate) {
            if (!dueDate) return 'No due date';
            const date = new Date(dueDate);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        }

        function sortMessages(messages) {
            if (currentSort === 'due-date') {
                // Sort by due date: overdue first, then by date, tasks without dates at end, non-tasks at very end
                return [...messages].sort((a, b) => {
                    const aIsTask = a.type === 'task';
                    const bIsTask = b.type === 'task';
                    
                    // Non-tasks go to the end
                    if (!aIsTask && bIsTask) return 1;
                    if (aIsTask && !bIsTask) return -1;
                    if (!aIsTask && !bIsTask) return 0;
                    
                    // Both are tasks
                    const aHasDate = !!a.dueDate;
                    const bHasDate = !!b.dueDate;
                    
                    // Tasks without dates go after tasks with dates
                    if (!aHasDate && bHasDate) return 1;
                    if (aHasDate && !bHasDate) return -1;
                    if (!aHasDate && !bHasDate) return 0;
                    
                    // Both have dates - sort by date (earliest first)
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
            }
            // Default: recent first (preserve original order)
            return messages;
        }

        function renderMessages() {
            const container = document.getElementById('messages-container');
            
            let filteredMessages = allMessages.filter(msg => {
                // Apply filter
                if (currentFilter === 'email' && msg.platform !== 'email') return false;
                if (currentFilter === 'teams' && msg.platform !== 'teams') return false;
                if (currentFilter === 'tasks' && (msg.type !== 'task' || msg.completed)) return false;
                if (currentFilter === 'calendar' && msg.type !== 'calendar') return false;
                if (currentFilter === 'active-tasks' && (msg.type !== 'task' || msg.completed)) return false;
                if (currentFilter === 'handwritten' && msg.platform !== 'handwritten') return false;
                
                // Apply tag filter
                if (currentTagFilter && (!msg.tags || !msg.tags.includes(currentTagFilter))) return false;
                
                // Apply search
                if (currentSearch) {
                    const searchLower = currentSearch.toLowerCase();
                    const matchesText = (msg.sender && msg.sender.toLowerCase().includes(searchLower)) ||
                           msg.subject.toLowerCase().includes(searchLower) ||
                           msg.preview.toLowerCase().includes(searchLower) ||
                           (msg.location && msg.location.toLowerCase().includes(searchLower));
                    const matchesTags = msg.tags && msg.tags.some(tag => tag.toLowerCase().includes(searchLower));
                    return matchesText || matchesTags;
                }
                
                return true;
            });

            // Apply sorting
            filteredMessages = sortMessages(filteredMessages);

            if (filteredMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div>No items found</div>
                    </div>
                `;
                updateStats(0, 0, 0, 0);
                return;
            }

            const unreadCount = filteredMessages.filter(m => m.unread && m.type !== 'task' && m.type !== 'calendar').length;
            const activeTaskCount = filteredMessages.filter(m => m.type === 'task' && !m.completed).length;
            const calendarCount = filteredMessages.filter(m => m.type === 'calendar').length;
            updateStats(filteredMessages.length, unreadCount, activeTaskCount, calendarCount);

            container.innerHTML = filteredMessages.map(msg => `
                <div class="message-item ${msg.unread ? 'unread' : ''} ${msg.type === 'task' ? 'task' : ''} ${msg.type === 'calendar' ? 'calendar' : ''} ${msg.completed ? 'completed' : ''}" data-id="${msg.id}">
                    ${msg.type === 'task' ? `
                        <div class="task-checkbox ${msg.completed ? 'checked' : ''}" data-task-id="${msg.id}"></div>
                    ` : ''}
                    <div class="message-content">
                        <div class="message-header">
                            <span class="platform-badge ${msg.platform}">${msg.platform}</span>
                            ${msg.sender ? `<span class="sender-name">${msg.sender}</span>` : ''}
                            <span class="timestamp">${msg.timestamp}</span>
                        </div>
                        <div class="message-subject">
                            ${msg.subject}
                            ${msg.type === 'task' && msg.dueDate ? getDueDateBadge(msg.dueDate) : ''}
                            ${msg.type === 'calendar' && msg.eventTime ? `<span class="event-time">üìÖ ${msg.eventTime}</span>` : ''}
                        </div>
                        <div class="message-preview">${msg.preview}</div>
                        ${msg.tags && msg.tags.length > 0 ? `
                            <div class="item-tags">
                                ${msg.tags.map(tag => `<span class="item-tag ${tag}">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Add click handlers for checkboxes
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(checkbox.dataset.taskId);
                    toggleTaskCompletion(taskId);
                });
            });

            // Add click handlers for items
            document.querySelectorAll('.message-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('task-checkbox')) {
                        const id = parseInt(item.dataset.id);
                        showMessageDetail(id);
                    }
                });
            });
        }

        function toggleTaskCompletion(taskId) {
            const task = allMessages.find(m => m.id === taskId);
            if (task) {
                task.completed = !task.completed;
                renderMessages();
            }
        }

        function updateStats(total, unread, activeTasks, calendarEvents) {
            document.getElementById('message-count').textContent = `${total} item${total !== 1 ? 's' : ''}`;
            const parts = [];
            if (unread > 0) parts.push(`${unread} unread`);
            if (activeTasks > 0) parts.push(`${activeTasks} active task${activeTasks !== 1 ? 's' : ''}`);
            if (calendarEvents > 0) parts.push(`${calendarEvents} event${calendarEvents !== 1 ? 's' : ''}`);
            document.getElementById('unread-count').textContent = parts.join(' ‚Ä¢ ');
        }

        function showMessageDetail(id) {
            const message = allMessages.find(m => m.id === id);
            if (!message) return;

            // Mark as read
            if (message.unread) {
                message.unread = false;
                renderMessages();
            }

            const detailContent = document.getElementById('detail-content');
            const detailActions = document.getElementById('detail-actions');

            let metaHtml = `
                <div class="detail-meta">
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Type:</div>
                        <div class="detail-meta-value">
                            <span class="platform-badge ${message.platform}">${message.platform}</span>
                        </div>
                    </div>
            `;

            if (message.sender) {
                metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">From:</div>
                        <div class="detail-meta-value">${message.sender}</div>
                    </div>
                `;
            }

            if (message.from) {
                metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Email:</div>
                        <div class="detail-meta-value">${message.from}</div>
                    </div>
                `;
            }

            if (message.channel) {
                metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Channel:</div>
                        <div class="detail-meta-value">${message.channel}</div>
                    </div>
                `;
            }

            metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Time:</div>
                        <div class="detail-meta-value">${message.timestamp}</div>
                    </div>
            `;

            if (message.type === 'task') {
                metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Status:</div>
                        <div class="detail-meta-value">${message.completed ? '‚úÖ Completed' : '‚è≥ Active'}</div>
                    </div>
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Due Date:</div>
                        <div class="detail-meta-value">${message.dueDate ? formatDueDate(message.dueDate) : 'No due date set'}</div>
                    </div>
                `;
            }

            if (message.type === 'calendar') {
                metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Date:</div>
                        <div class="detail-meta-value">${message.eventDate ? formatDueDate(message.eventDate) : 'TBD'}</div>
                    </div>
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">Time:</div>
                        <div class="detail-meta-value">${message.eventTime}${message.eventEndTime ? ' - ' + message.eventEndTime : ''}</div>
                    </div>
                    ${message.location ? `
                        <div class="detail-meta-row">
                            <div class="detail-meta-label">Location:</div>
                            <div class="detail-meta-value">${message.location}</div>
                        </div>
                    ` : ''}
                `;
            }

            metaHtml += `
                    <div class="detail-meta-row">
                        <div class="detail-meta-label">${message.type === 'task' ? 'Task' : 'Subject'}:</div>
                        <div class="detail-meta-value"><strong>${message.subject}</strong></div>
                    </div>
                    ${message.tags && message.tags.length > 0 ? `
                        <div class="detail-meta-row">
                            <div class="detail-meta-label">Tags:</div>
                            <div class="detail-meta-value">
                                ${message.tags.map(tag => `<span class="item-tag ${tag}">${tag}</span>`).join(' ')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            detailContent.innerHTML = metaHtml + `<div class="detail-body">${message.body.replace(/\n/g, '<br>')}</div>`;

            // Show "Make this a Task" button for non-task items
            if (message.type !== 'task') {
                detailActions.innerHTML = `
                    <button class="detail-action-button primary" id="make-task-button">
                        ‚úÖ Make this a Task
                    </button>
                `;
                
                document.getElementById('make-task-button').addEventListener('click', () => {
                    convertToTask(message.id);
                });
            } else {
                detailActions.innerHTML = '';
            }

            document.getElementById('message-detail').classList.add('active');
        }

        function convertToTask(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (!message) return;

            // If converting calendar event, use event date as due date
            const dueDate = message.type === 'calendar' && message.eventDate ? message.eventDate : null;

            const newTask = {
                id: nextId++,
                type: 'task',
                platform: 'typed',
                sender: '',
                subject: message.subject,
                preview: message.preview,
                body: message.body,
                timestamp: 'Just now',
                unread: false,
                completed: false,
                dueDate: dueDate,
                tags: message.tags || []
            };

            allMessages.unshift(newTask);
            document.getElementById('message-detail').classList.remove('active');
            renderTagFilters();
            renderMessages();

            // Show confirmation
            setTimeout(() => {
                alert('‚úÖ Converted to task!' + (dueDate ? ' Due date set to event date.' : '') + ' You can now track it in the Tasks view.');
            }, 100);
        }

        // Event listeners
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderMessages();
            });
        });

        document.querySelector('.search-input').addEventListener('input', (e) => {
            currentSearch = e.target.value;
            renderMessages();
        });

        document.getElementById('sort-select').addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderMessages();
        });

        document.getElementById('back-button').addEventListener('click', () => {
            document.getElementById('message-detail').classList.remove('active');
        });

        document.querySelector('.fab').addEventListener('click', () => {
            document.getElementById('compose-modal').classList.add('active');
        });

        // Compose modal handlers
        document.getElementById('close-compose').addEventListener('click', () => {
            document.getElementById('compose-modal').classList.remove('active');
        });

        document.getElementById('cancel-compose').addEventListener('click', () => {
            document.getElementById('compose-modal').classList.remove('active');
        });

        document.getElementById('compose-modal').addEventListener('click', (e) => {
            if (e.target.id === 'compose-modal') {
                document.getElementById('compose-modal').classList.remove('active');
            }
        });

        // Handwriting Recognition functionality
        const canvas = document.getElementById('handwriting-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let strokes = [];
        let currentStroke = [];

        // Set up canvas drawing
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#333';

        function startDrawing(e) {
            isDrawing = true;
            currentStroke = [];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            currentStroke.push({ x: x * scaleX, y: y * scaleY });
            ctx.beginPath();
            ctx.moveTo(x * scaleX, y * scaleY);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            currentStroke.push({ x: x * scaleX, y: y * scaleY });
            ctx.lineTo(x * scaleX, y * scaleY);
            ctx.stroke();
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            if (currentStroke.length > 0) {
                strokes.push([...currentStroke]);
            }
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        // Clear canvas
        document.getElementById('clear-canvas').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes = [];
            currentStroke = [];
            const recognizedText = document.getElementById('recognized-text');
            recognizedText.textContent = 'Recognized text will appear here...';
            recognizedText.classList.add('empty');
        });

        // Undo last stroke
        document.getElementById('undo-stroke').addEventListener('click', () => {
            if (strokes.length > 0) {
                strokes.pop();
                redrawCanvas();
            }
        });

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes.forEach(stroke => {
                if (stroke.length > 0) {
                    ctx.beginPath();
                    ctx.moveTo(stroke[0].x, stroke[0].y);
                    stroke.forEach(point => {
                        ctx.lineTo(point.x, point.y);
                    });
                    ctx.stroke();
                }
            });
        }

        // Handwriting recognition using Claude API
        document.getElementById('recognize-text').addEventListener('click', async () => {
            if (strokes.length === 0) {
                alert('Please write something first!');
                return;
            }

            const recognizedText = document.getElementById('recognized-text');
            recognizedText.textContent = 'Converting handwriting...';
            recognizedText.classList.add('empty');

            try {
                // Convert canvas to image
                const imageData = canvas.toDataURL('image/png');
                const base64Image = imageData.split(',')[1];

                // Call Claude API with vision to recognize handwriting
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: 'image/png',
                                        data: base64Image
                                    }
                                },
                                {
                                    type: 'text',
                                    text: 'Please transcribe any handwritten text you see in this image. Return only the transcribed text, nothing else. If you cannot read the handwriting or there is no text, respond with "Could not recognize handwriting".'
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const transcribedText = data.content.find(item => item.type === 'text')?.text || 'Could not recognize handwriting';

                recognizedText.textContent = transcribedText;
                recognizedText.classList.remove('empty');

            } catch (error) {
                console.error('Handwriting recognition error:', error);
                
                // Fallback demo mode with simple pattern recognition
                recognizedText.textContent = demoHandwritingRecognition(strokes);
                recognizedText.classList.remove('empty');
            }
        });

        // Simple demo handwriting recognition (fallback)
        function demoHandwritingRecognition(strokes) {
            if (strokes.length === 0) return 'No handwriting detected';
            
            const strokeCount = strokes.length;
            const avgStrokeLength = strokes.reduce((sum, stroke) => sum + stroke.length, 0) / strokeCount;
            
            if (strokeCount <= 3 && avgStrokeLength < 20) {
                return 'Hi';
            } else if (strokeCount <= 5) {
                return 'Hello';
            } else if (strokeCount <= 10) {
                return 'Hello, how are you?';
            } else {
                return 'Thank you for your message. I will get back to you soon.';
            }
        }

        // Open handwriting modal
        document.getElementById('handwriting-button').addEventListener('click', () => {
            document.getElementById('handwriting-modal').classList.add('active');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes = [];
            const recognizedText = document.getElementById('recognized-text');
            recognizedText.textContent = 'Recognized text will appear here...';
            recognizedText.classList.add('empty');
        });

        // Close handwriting modal
        document.getElementById('close-handwriting').addEventListener('click', () => {
            document.getElementById('handwriting-modal').classList.remove('active');
        });

        document.getElementById('cancel-handwriting').addEventListener('click', () => {
            document.getElementById('handwriting-modal').classList.remove('active');
        });

        // Insert recognized text into message
        document.getElementById('insert-handwriting').addEventListener('click', () => {
            const recognizedText = document.getElementById('recognized-text');
            const text = recognizedText.textContent;
            
            if (!text || text === 'Recognized text will appear here...' || recognizedText.classList.contains('empty')) {
                alert('Please write something and click "Convert to Text" first!');
                return;
            }

            const textarea = document.getElementById('message-textarea');
            const currentText = textarea.value;
            textarea.value = currentText + (currentText ? '\n\n' : '') + text;
            
            document.getElementById('handwriting-modal').classList.remove('active');
        });

        // Voice to Text functionality
        let recognition = null;
        let isRecording = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            let finalTranscript = '';

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('voice-button').classList.add('recording');
                document.getElementById('voice-status').textContent = 'üé§ Listening...';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const textarea = document.getElementById('message-textarea');
                textarea.value = finalTranscript + interimTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                document.getElementById('voice-button').classList.remove('recording');
                document.getElementById('voice-status').textContent = '‚ùå Error: ' + event.error;
                setTimeout(() => {
                    document.getElementById('voice-status').textContent = '';
                }, 3000);
            };

            recognition.onend = () => {
                isRecording = false;
                document.getElementById('voice-button').classList.remove('recording');
                document.getElementById('voice-status').textContent = '';
                
                const textarea = document.getElementById('message-textarea');
                textarea.value = finalTranscript;
            };
        }

        document.getElementById('voice-button').addEventListener('click', () => {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please try Chrome or Safari.');
                return;
            }

            if (isRecording) {
                recognition.stop();
                document.getElementById('voice-button').classList.remove('recording');
                document.getElementById('voice-status').textContent = '';
            } else {
                finalTranscript = document.getElementById('message-textarea').value;
                recognition.start();
            }
        });

        // AI Writing Assistant functionality
        document.getElementById('ai-button').addEventListener('click', async () => {
            const textarea = document.getElementById('message-textarea');
            const currentText = textarea.value.trim();
            const subject = document.getElementById('subject-input').value.trim();
            const suggestionsContainer = document.getElementById('suggestions-container');
            const aiSuggestions = document.getElementById('ai-suggestions');

            if (!currentText && !subject) {
                alert('Please enter a task title or start writing first.');
                return;
            }

            suggestionsContainer.innerHTML = '<div style="text-align: center; padding: 12px;"><span class="loading-spinner"></span> Generating suggestions...</div>';
            aiSuggestions.classList.add('active');

            // Demo mode with templates
            setTimeout(() => {
                suggestionsContainer.innerHTML = `
                    <div style="padding: 8px; color: #666; margin-bottom: 8px;">
                        <strong>Quick Suggestions</strong>
                    </div>
                    <div class="suggestion-option" data-template="detailed">
                        <strong>Make it Detailed</strong><br>
                        Add specific steps and deadlines
                    </div>
                    <div class="suggestion-option" data-template="concise">
                        <strong>Keep it Simple</strong><br>
                        Short and actionable
                    </div>
                    <div class="suggestion-option" data-template="prioritized">
                        <strong>Add Priority Context</strong><br>
                        Include importance and urgency
                    </div>
                `;

                document.querySelectorAll('.suggestion-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const template = option.dataset.template;
                        const demoTexts = {
                            detailed: `${currentText || subject}\n\nSteps:\n1. [First step]\n2. [Second step]\n3. [Final step]\n\nDeadline: [Date]\nPriority: Medium`,
                            concise: `${currentText || subject}`,
                            prioritized: `üî¥ HIGH PRIORITY\n\n${currentText || subject}\n\nWhy it matters: [Add context]\nDue: ASAP`
                        };
                        textarea.value = demoTexts[template] || currentText;
                        aiSuggestions.classList.remove('active');
                    });
                });
            }, 500);
        });

        document.getElementById('send-message').addEventListener('click', () => {
            const platform = document.getElementById('platform-select').value;
            const subject = document.getElementById('subject-input').value;
            const message = document.getElementById('message-textarea').value;
            const dueDate = document.getElementById('due-date-input').value;
            const tagsInput = document.getElementById('tags-input').value;

            if (!subject) {
                alert('Please enter a task title.');
                return;
            }

            // Parse tags
            const tags = tagsInput
                .split(',')
                .map(tag => tag.trim().toLowerCase())
                .filter(tag => tag.length > 0);

            const newTask = {
                id: nextId++,
                type: 'task',
                platform: platform,
                sender: '',
                subject: subject,
                preview: message || subject,
                body: message || subject,
                timestamp: 'Just now',
                unread: false,
                completed: false,
                dueDate: dueDate || null,
                tags: tags
            };

            allMessages.unshift(newTask);
            renderTagFilters();
            renderMessages();
            
            document.getElementById('subject-input').value = '';
            document.getElementById('message-textarea').value = '';
            document.getElementById('due-date-input').value = '';
            document.getElementById('tags-input').value = '';
            document.getElementById('ai-suggestions').classList.remove('active');
            document.getElementById('compose-modal').classList.remove('active');
        });

        // Initial render
        renderTagFilters();
        renderMessages();
    </script>
</body>
</html>
